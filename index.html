<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Configurable Local IPA Packager</title>
<style>
  textarea { width: 100%; height: 120px; font-family: monospace; }
  input[type=text] { width: 100%; }
  label { font-weight: bold; }
  button { margin: 4px 0; }
</style>
</head>
<body>
  <h2>Local IPA Packager (No Build, No Sign)</h2>

  <label for="baseFolderInput">Base folder inside IPA (e.g. Payload):</label><br/>
  <input type="text" id="baseFolderInput" value="Payload" /><br/><br/>

  <label for="appNameInput">App folder name (e.g. YourApp.app):</label><br/>
  <input type="text" id="appNameInput" value="YourApp.app" /><br/><br/>

  <input type="file" id="fileInput" webkitdirectory multiple />
  <button id="addFilesBtn">Add Files/Folder to Storage</button>
  <button id="clearStorageBtn" style="margin-left: 20px;">Clear Storage</button>
  <hr />

  <h3>Create/Edit Text File</h3>
  <label>File path inside app folder (e.g. Info.plist or folder/file.txt):</label><br/>
  <input type="text" id="newFilePath" placeholder="e.g. Info.plist" /><br/><br/>
  <label>File content (text only):</label><br/>
  <textarea id="newFileContent" placeholder="Write your file content here..."></textarea><br/>
  <button id="addTextFileBtn">Add Text File to Storage</button>
  <hr />

  <button id="downloadIpaBtn">Download IPA</button>

  <h3>Stored Files:</h3>
  <ul id="fileList"></ul>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const addFilesBtn = document.getElementById('addFilesBtn');
    const clearStorageBtn = document.getElementById('clearStorageBtn');
    const downloadIpaBtn = document.getElementById('downloadIpaBtn');
    const fileList = document.getElementById('fileList');
    const newFilePath = document.getElementById('newFilePath');
    const newFileContent = document.getElementById('newFileContent');
    const addTextFileBtn = document.getElementById('addTextFileBtn');
    const baseFolderInput = document.getElementById('baseFolderInput');
    const appNameInput = document.getElementById('appNameInput');

    const STORAGE_KEY = 'localIpaFiles';

    // Load stored files: array of { path: string, base64: string }
    function loadStoredFiles() {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }

    // Save files array to localStorage
    function saveStoredFiles(files) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(files));
    }

    // Update file list UI
    function updateFileList() {
      const files = loadStoredFiles();
      fileList.innerHTML = '';
      files.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f.path;
        fileList.appendChild(li);
      });
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]); // base64 only
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Build full internal path for stored files
    function buildFullPath(relativePath) {
      const baseFolder = baseFolderInput.value.trim() || 'Payload';
      const appName = appNameInput.value.trim() || 'YourApp.app';
      // If relativePath already starts with baseFolder/appName, avoid double prefix
      if (relativePath.startsWith(baseFolder + '/' + appName)) {
        return relativePath;
      }
      // Else prefix
      return `${baseFolder}/${appName}/${relativePath}`;
    }

    addFilesBtn.onclick = async () => {
      if (!fileInput.files.length) {
        alert('Select files or folders first');
        return;
      }
      const storedFiles = loadStoredFiles();

      for (const file of fileInput.files) {
        // file.webkitRelativePath includes folder structure relative to root folder you selected
        const relativePath = file.webkitRelativePath;
        const fullPath = buildFullPath(relativePath);
        const base64 = await fileToBase64(file);
        storedFiles.push({ path: fullPath, base64 });
      }

      saveStoredFiles(storedFiles);
      updateFileList();
      alert('Files/folders added to storage!');
      fileInput.value = '';
    };

    addTextFileBtn.onclick = () => {
      const path = newFilePath.value.trim();
      const content = newFileContent.value;
      if (!path) {
        alert('Please enter a file path');
        return;
      }
      const storedFiles = loadStoredFiles();

      const fullPath = buildFullPath(path);

      // Convert text content to base64 (UTF-8)
      const base64 = btoa(unescape(encodeURIComponent(content)));

      storedFiles.push({ path: fullPath, base64 });
      saveStoredFiles(storedFiles);
      updateFileList();
      alert('Text file added!');
      newFilePath.value = '';
      newFileContent.value = '';
    };

    clearStorageBtn.onclick = () => {
      if(confirm('Are you sure you want to clear all stored files? This cannot be undone.')) {
        localStorage.removeItem(STORAGE_KEY);
        updateFileList();
        alert('Storage cleared.');
      }
    };

    downloadIpaBtn.onclick = async () => {
      const files = loadStoredFiles();
      if (!files.length) {
        alert('No files stored! Add files/folders first.');
        return;
      }

      const zip = new JSZip();

      for (const f of files) {
        zip.file(f.path, f.base64, { base64: true });
      }

      const baseFolder = baseFolderInput.value.trim() || 'Payload';
      const appName = appNameInput.value.trim() || 'YourApp.app';

      // Just to be sure, check that at least one file is inside baseFolder/appName folder
      const hasAppFolder = files.some(f => f.path.startsWith(baseFolder + '/' + appName + '/'));
      if (!hasAppFolder) {
        alert(`Warning: None of the files are inside the folder ${baseFolder}/${appName}/`);
      }

      const content = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${appName.replace(/[^a-z0-9]/gi,'_').toLowerCase()}.ipa`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // On load
    updateFileList();
  </script>
</body>
</html>
