<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Local IPA Packager with Text File Creator</title>
<style>
  textarea { width: 100%; height: 120px; font-family: monospace; }
  input[type=text] { width: 100%; }
</style>
</head>
<body>
  <h2>Local IPA Packager (No Build, No Sign)</h2>

  <input type="file" id="fileInput" webkitdirectory multiple />
  <button id="addFilesBtn">Add Files/Folder to Storage</button>
  <hr />

  <h3>Create/Edit Text File</h3>
  <label>File path inside app (relative to YourApp.app, e.g. Info.plist or folder/file.txt):</label><br/>
  <input type="text" id="newFilePath" placeholder="e.g. Info.plist" /><br/><br/>
  <label>File content (text only):</label><br/>
  <textarea id="newFileContent" placeholder="Write your file content here..."></textarea><br/>
  <button id="addTextFileBtn">Add Text File to Storage</button>
  <hr />

  <button id="downloadIpaBtn">Download IPA</button>

  <h3>Stored Files:</h3>
  <ul id="fileList"></ul>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const addFilesBtn = document.getElementById('addFilesBtn');
    const downloadIpaBtn = document.getElementById('downloadIpaBtn');
    const fileList = document.getElementById('fileList');
    const newFilePath = document.getElementById('newFilePath');
    const newFileContent = document.getElementById('newFileContent');
    const addTextFileBtn = document.getElementById('addTextFileBtn');

    const STORAGE_KEY = 'localIpaFiles';
    const APP_NAME = 'YourApp'; // Change to your app's name exactly (YourApp.app folder)

    // Load stored files: array of { path: string, base64: string }
    function loadStoredFiles() {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }

    // Save files array to localStorage
    function saveStoredFiles(files) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(files));
    }

    // Update file list UI
    function updateFileList() {
      const files = loadStoredFiles();
      fileList.innerHTML = '';
      files.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f.path;
        fileList.appendChild(li);
      });
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]); // base64 only
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    addFilesBtn.onclick = async () => {
      if (!fileInput.files.length) {
        alert('Select files or folders first');
        return;
      }
      const storedFiles = loadStoredFiles();

      for (const file of fileInput.files) {
        // file.webkitRelativePath includes folder structure relative to root folder you selected
        // We want to place all files under Payload/YourApp.app/
        const relativePath = `Payload/${APP_NAME}.app/${file.webkitRelativePath}`;
        const base64 = await fileToBase64(file);
        storedFiles.push({ path: relativePath, base64 });
      }

      saveStoredFiles(storedFiles);
      updateFileList();
      alert('Files/folders added to storage!');
      fileInput.value = '';
    };

    addTextFileBtn.onclick = () => {
      const path = newFilePath.value.trim();
      const content = newFileContent.value;
      if (!path) {
        alert('Please enter a file path');
        return;
      }
      const storedFiles = loadStoredFiles();
      // Add the file under Payload/YourApp.app/ path
      const fullPath = `Payload/${APP_NAME}.app/${path}`;

      // Convert text content to base64 (UTF-8)
      const base64 = btoa(unescape(encodeURIComponent(content)));

      storedFiles.push({ path: fullPath, base64 });
      saveStoredFiles(storedFiles);
      updateFileList();
      alert('Text file added!');
      newFilePath.value = '';
      newFileContent.value = '';
    };

    downloadIpaBtn.onclick = async () => {
      const files = loadStoredFiles();
      if (!files.length) {
        alert('No files stored! Add files/folders first.');
        return;
      }

      const zip = new JSZip();

      for (const f of files) {
        zip.file(f.path, f.base64, { base64: true });
      }

      const content = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${APP_NAME}.ipa`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // On load
    updateFileList();
  </script>
</body>
</html>
